<%
  is_story = type == :story
  css_class = item.imported ? "imported" : ""
  css_class += " donotimport" if item.donotimport
  css_class += " brokenLink" if item.has_attribute?(:brokenlink) && item.brokenlink
  css_class += " #{type}"
  item_id = "#{type}-#{item.id}"
%>

<section class="row item <%= css_class %>"
         id="<%= item_id %>">
  <div class="col-lg-6 col-md-7 col-sm-6">

    <!-- Title and authors -->
    <h4>
      <span class="badge badge-info"><%= item.id %></span>
      <a href="<%= "#meta-#{item_id}" %>" data-toggle="collapse" aria-expanded="false" aria-controls="<%= "meta-#{item_id}" %>">
        <% if (is_story || type == :coauthored_story) && item.chapters.size > 0 %>
          <span><%= item.title %></span>
        <% else %>
          <a href="<%= item.url %>"><%= item.title %></a>
        <% end %>

        <% if !author_view || item.coauthor? %>
        <span>by <b><%= item.author.name %></b>
          <% if item.coauthor? %>
            <span>and <b><%= item.coauthor.name %></b></span>
          <% end %>
        </span>
        <% end %>

        <% if is_story %>
          (<%= item.chapters.size %> chapters)
        <% else %>
          <span><a href="<%= "#meta-#{type}-#{item.id}" %>" data-toggle="collapse">(expand)</a></span>
        <% end %>
        <% if item.importnotes.present? %>
          <span><span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span></span>
        <% end %>
      </a>
    </h4>

    <!-- Blurb -->
    <div id="<%= "meta-#{item_id}" %>" class="<%= "blurb-#{item_id}" %> collapse">
      <span class="summary">[<%= item.rating %>]
        <% if item.categories.present? %>
          - <%= item.categories %>
        <% end %>
        <% if item.fandoms.present? %>
          - <b>Fandoms:</b> <%= item.fandoms %>
        <% end %>
        <br/>

        <% if item.date.present? %>
          <b>Date:</b> <%= item.date %>
          <!--@Model.Date.ToString("yyyy-MM-dd")-->
          <% if is_story && item.updated.present? %>
            - <b>Updated:</b> <%= item.updated %>
            <!--ToString("yyyy-MM-dd")-->
          <% end %>
          <br/>
        <% end %>

        <% if item.warnings.present? %>
          <b>Warnings:</b> <%= item.warnings %><br/>
        <% end %>
        <% if item.relationships.present? %>
          <b>Relationships:</b> <%= item.relationships %><br/>
        <% end %>
        <% if item.characters.present? %>
          <b>Characters:</b> <%= item.characters %><br/>
        <% end %>
        <% if item.tags.present? %>
          <b>Tags:</b> <%= item.tags %><br/>
        <% end %>
      </span>

      <span class="summary"><b>Summary:</b> <%= item.summary.html_safe %></span><br/>

      <% if is_story %>
        <ol>
          <% item.chapters.each do |chapter| %>
            <li>
              <%= chapter.title %>
              <% #= link_to chapter.title,
                 # actionName: "Details",
                 # controllerName: "Chapter",
                 # routeValues: {id = chapter.ID},
                 # htmlAttributes: new {}
              %>
            </li>
          <% end %>
        </ol>
      <% end %>
    </div><!-- end meta -->
  </div>

  <!-- Buttons -->
  <% if type != :coauthored_story %>
    <%= link_to "Import", item_import_path(type, item.id),
                id: "item-import-#{item.id}", remote: true,
                data: {method: :post, button: :import, item: item.id, type: type, class: "btn btn-info"} %>
  <% end %>

  <!-- Audit -->
  <div id="<%= "audit-#{item_id}" %>" class="col-lg-6 col-md-5 col-sm-6 audit blurb-<%= item_id %> collapse">
    <%= item.importnotes %>
  </div>

  <% if "(hasStoryResult || hasBookmarkResult)" == "true" %>
    <div class="message-info <%=  %>">
      <ul>
        <% messages.each do |s| %>
          <li><%= s.html_safe %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
</section>
